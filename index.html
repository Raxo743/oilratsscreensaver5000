<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>5000 Small Oilrats Optimized</title>
  <style>
    body { margin:0; overflow:hidden; }
    canvas { display:block; background:#f0f0f0; cursor:grab; }
    canvas:active { cursor:grabbing; }
  </style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

let gravityEnabled = true;
const friction = 0.9;
const originalSize = 60;
const size = originalSize / 8; // 8x smaller

const img = new Image();
img.src = 'oilrats.png';
const magnetImg = new Image();
magnetImg.src = 'ak48.png';

class Oilrat {
  constructor(x, y, isMagnet=false){
    this.x = x;
    this.y = y;
    this.vx = 0;
    this.vy = 0;
    this.size = size;
    this.dragging = false;
    this.isMagnet = isMagnet;
    this.heldDown = false;
  }

  draw(){
    if(this.isMagnet && magnetImg.complete){
      ctx.drawImage(magnetImg, this.x-this.size/2, this.y-this.size/2, this.size, this.size);
    } else if(img.complete){
      ctx.drawImage(img, this.x-this.size/2, this.y-this.size/2, this.size, this.size);
    } else {
      ctx.fillStyle = this.isMagnet ? "red" : "gray";
      ctx.fillRect(this.x-this.size/2, this.y-this.size/2, this.size, this.size);
    }
  }

  update(){
    if(!this.dragging){
      if(gravityEnabled) this.vy += 0.5;
      this.x += this.vx;
      this.y += this.vy;

      // collision with edges
      if(this.y + this.size/2 > canvas.height){ this.y = canvas.height-this.size/2; this.vy*=-friction; this.vx*=friction; }
      if(this.y - this.size/2 < 0){ this.y=this.size/2; this.vy*=-friction; }
      if(this.x + this.size/2 > canvas.width){ this.x=canvas.width-this.size/2; this.vx*=-friction; }
      if(this.x - this.size/2 < 0){ this.x=this.size/2; this.vx*=-friction; }
    }
    this.draw();
  }

  isPointInside(px, py){
    return px>=this.x-this.size/2 && px<=this.x+this.size/2 && py>=this.y-this.size/2 && py<=this.y+this.size/2;
  }
}

// generate 5000 oilrats
const squares = [];
for(let i=0;i<5000;i++){
  const x = Math.random()*(canvas.width-size)+size/2;
  const y = Math.random()*(canvas.height/2);
  squares.push(new Oilrat(x,y));
}

// magnet
const magnetSquare = new Oilrat(canvas.width/2, canvas.height/2, true);
squares.push(magnetSquare);

// buttons
const toggleButton = {x:20, y:20, size:40};
const boostButton = {size:40};
function updateBoostButton(){ boostButton.x=canvas.width-boostButton.size-20; boostButton.y=20;}
updateBoostButton();
window.addEventListener('resize', updateBoostButton);

let draggingSquare=null;
let offsetX=0, offsetY=0;

canvas.addEventListener('mousedown', e=>{
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX-rect.left;
  const mouseY = e.clientY-rect.top;

  if(mouseX>=toggleButton.x && mouseX<=toggleButton.x+toggleButton.size &&
     mouseY>=toggleButton.y && mouseY<=toggleButton.y+toggleButton.size){
       gravityEnabled=!gravityEnabled;
       if(!gravityEnabled)squares.forEach(sq=>{sq.vx*=0.1; sq.vy*=0.1;});
       return;
  }

  if(mouseX>=boostButton.x && mouseX<=boostButton.x+boostButton.size &&
     mouseY>=boostButton.y && mouseY<=boostButton.y+boostButton.size){
       squares.forEach(sq=>{
         if(!sq.isMagnet){
           const speed = Math.sqrt(sq.vx*sq.vx+sq.vy*sq.vy)*1.25+2;
           const angle = Math.random()*Math.PI*2;
           sq.vx=Math.cos(angle)*speed;
           sq.vy=Math.sin(angle)*speed;
         }
       });
       return;
  }

  for(let i=squares.length-1;i>=0;i--){
    if(squares[i].isPointInside(mouseX,mouseY)){
      draggingSquare = squares[i];
      draggingSquare.dragging = true;
      if(draggingSquare.isMagnet) draggingSquare.heldDown = true;
      offsetX = mouseX - draggingSquare.x;
      offsetY = mouseY - draggingSquare.y;
      draggingSquare.vx=0; draggingSquare.vy=0;
      break;
    }
  }
});

canvas.addEventListener('mousemove', e=>{
  if(!draggingSquare) return;
  const rect = canvas.getBoundingClientRect();
  draggingSquare.x = e.clientX - rect.left - offsetX;
  draggingSquare.y = e.clientY - rect.top - offsetY;
});

canvas.addEventListener('mouseup', e=>{
  if(draggingSquare){ draggingSquare.dragging=false; draggingSquare.heldDown=false; draggingSquare=null;}
});
canvas.addEventListener('mouseleave', e=>{
  if(draggingSquare){ draggingSquare.dragging=false; draggingSquare.heldDown=false; draggingSquare=null;}
});

// optimized animation
function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // draw buttons
  ctx.fillStyle="blue";
  ctx.fillRect(toggleButton.x,toggleButton.y,toggleButton.size,toggleButton.size);
  ctx.fillStyle="green";
  ctx.fillRect(boostButton.x,boostButton.y,boostButton.size,boostButton.size);

  // magnet effect
  if(magnetSquare.heldDown){
    squares.forEach(sq=>{
      if(!sq.isMagnet){
        const dx = magnetSquare.x - sq.x;
        const dy = magnetSquare.y - sq.y;
        const dist = Math.sqrt(dx*dx+dy*dy)||1;
        const pull = 0.15;
        sq.vx += dx/dist*pull;
        sq.vy += dy/dist*pull;
        const floatStr = 0.02;
        sq.x += dx*floatStr;
        sq.y += dy*floatStr;
      }
    });
  }

  // update + draw
  squares.forEach(sq=>sq.update());

  requestAnimationFrame(animate);
}

animate();
</script>
</body>
</html>

